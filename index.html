<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta http-equiv="pragma" content="no-cache"/>
    <title>Created with GameMaker</title>
    <style>
        body, html {
            background: #000;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100%;
            width: 100%;
        }
        canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
            image-rendering: optimizeSpeed;
            -webkit-interpolation-mode: nearest-neighbor;
            -ms-touch-action: none;
            touch-action: none;
        }
        :-webkit-full-screen #canvas, :-webkit-full-screen {
            width: 100%;
            height: 100%;
        }
        .gm4html5_div_class { margin: 0; padding: 0; border: 0; }
        .gm4html5_login {
            padding: 20px;
            position: absolute;
            border: 2px solid #000;
            background-color: #404040;
            color: #0f0;
            border-radius: 15px;
            box-shadow: #101010 20px 20px 40px;
        }
        .gm4html5_cancel_button { float: right; }
        .gm4html5_login_button { float: left; }
        .gm4html5_login_header { text-align: center; }
    </style>
</head>
<body>
    <div class="gm4html5_div_class" id="gm4html5_div_id">
        <canvas id="canvas"><p>Your browser doesn't support HTML5 canvas.</p></canvas>
    </div>

    <script type="text/javascript" src="html5game/NXTALE.js?cachebust=938571485"></script>
    <script>
        function resizeCanvasToPreset() {
            const canvas = document.getElementById('canvas');
            const container = document.getElementById('gm4html5_div_id');
            const screenW = window.innerWidth;
            const screenH = window.innerHeight;
            const resolutions = [
                { w: 1280, h: 720 }, { w: 1920, h: 1080 },
                { w: 2560, h: 1440 }, { w: 3840, h: 2160 }
            ];
            let chosen = resolutions[0];
            for (let r of resolutions) {
                if (screenW >= r.w && screenH >= r.h) chosen = r;
            }
            canvas.width = chosen.w;
            canvas.height = chosen.h;
            canvas.style.width = screenW + 'px';
            canvas.style.height = screenH + 'px';
            container.style.width = screenW + 'px';
            container.style.height = screenH + 'px';
            const ctx = canvas.getContext('2d');
            if (ctx) ctx.imageSmoothingEnabled = false;
        }

        window.addEventListener('load', () => {
            resizeCanvasToPreset();
            GameMaker_Init();
        });

        window.addEventListener('resize', resizeCanvasToPreset);
        window.addEventListener('orientationchange', resizeCanvasToPreset);
    </script>

    <!-- âœ… Firebase Setup -->
<script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyDqDU6p8BH1hTqox7f5Sj1ySTWifIP2818",
    authDomain: "wigdos-9aa6a.firebaseapp.com",
    projectId: "wigdos-9aa6a",
    storageBucket: "wigdos-9aa6a.appspot.com",
    messagingSenderId: "124867645389",
    appId: "1:124867645389:web:4530e19e575669f3cabe84",
    measurementId: "G-1KTKSSCJ33"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let currentUser = "guest"; // default fallback

// Wait for Wigdos to send us the username
window.addEventListener("message", (event) => {
    // Optional: restrict by origin
    // if (event.origin !== "https://your-wigdos-domain.com") return;

    if (event.data?.type === "setUser") {
        currentUser = event.data.username || "guest";
        console.log("âœ… Username received from Wigdos:", currentUser);

        // Now that we have a user, try to auto-load their save
        loadGameFromFirebase();
    }
});

const saveKeys = [
    "CreatedwithGameMaker.0.file0",
    "CreatedwithGameMaker.0.file9",
    "CreatedwithGameMaker.0.undertale.ini"
];

// const currentUser = sessionStorage.getItem("username");

if (!currentUser) {
    console.warn("âš ï¸ No Wigdos user detected. Load this app from Wigdos.");
}

async function saveGameToFirebase() {
    if (!currentUser) return alert("Not logged in through Wigdos.");

    const data = {};
    saveKeys.forEach(key => {
        const val = localStorage.getItem(key);
        if (val !== null) data[key] = val;
    });

    try {
        await db.collection("game_saves").doc(currentUser).set(data);
        alert("âœ… Game saved to cloud for user: " + currentUser);
    } catch (err) {
        console.error("Save error:", err);
        alert("âŒ Failed to save.");
    }
}

async function loadGameFromFirebase() {
    if (!currentUser) return alert("Not logged in through Wigdos.");

    try {
        const doc = await db.collection("game_saves").doc(currentUser).get();
        if (!doc.exists) {
            alert("âš ï¸ No save found for user: " + currentUser);
            return;
        }

        const data = doc.data();
        saveKeys.forEach(key => {
            if (data[key]) localStorage.setItem(key, data[key]);
        });

        alert("âœ… Game loaded for: " + currentUser);
    } catch (err) {
        console.error("Load error:", err);
        alert("âŒ Failed to load.");
    }
}

// Add Save/Load buttons and auto-load on startup
window.addEventListener("DOMContentLoaded", () => {
   
    const controls = document.createElement("div");
    controls.style.position = "fixed";
    controls.style.top = "10px";
    controls.style.right = "10px";
    controls.style.zIndex = "9999";
    controls.style.background = "#222";
    controls.style.padding = "10px";
    controls.style.borderRadius = "10px";
    controls.style.color = "#fff";
    controls.innerHTML = `
        <div><strong>Signed in as:</strong> ${currentUser || "Guest"}</div><br>
        <button onclick="saveGameToFirebase()">ðŸ’¾ Save</button>
        <button onclick="loadGameFromFirebase()">ðŸ“‚ Load</button>
    `;
    document.body.appendChild(controls);
});
</script>

</body>
</html>
